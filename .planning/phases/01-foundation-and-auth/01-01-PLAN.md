---
phase: 01-foundation-and-auth
plan: 01
type: execute
wave: 1
wave_type: SEQUENTIAL
depends_on: []
files_modified:
  - server/app/__init__.py
  - server/app/main.py
  - server/app/config.py
  - server/app/dependencies.py
  - server/requirements.txt
  - server/pyproject.toml
  - server/.env.example
autonomous: true
difficulty: medium
enhancement_queries:
  - "FastAPI 0.115 project scaffold best practices with pydantic-settings v2 2026?"
  - "Python project structure for FastAPI with Supabase, Stripe, Redis, Celery 2026?"
  - "FastAPI dependency injection patterns for database and external service clients?"

must_haves:
  truths:
    - "FastAPI server starts and serves /health returning 200"
    - "Configuration loads from environment variables via pydantic-settings"
    - "Dependency injection provides Supabase client, Redis connection, and Stripe client"
  artifacts:
    - path: "server/app/main.py"
      provides: "FastAPI application entry point with CORS, routers, health endpoint"
      contains: "FastAPI"
    - path: "server/app/config.py"
      provides: "Settings class loading from env vars"
      contains: "BaseSettings"
    - path: "server/app/dependencies.py"
      provides: "Depends() callables for Supabase, Redis, Stripe"
      exports: ["get_supabase", "get_redis", "get_stripe"]
    - path: "server/requirements.txt"
      provides: "Python dependencies"
      contains: "fastapi"
  key_links:
    - from: "server/app/main.py"
      to: "server/app/config.py"
      via: "settings import"
      pattern: "from.*config.*import.*settings"
    - from: "server/app/main.py"
      to: "server/app/dependencies.py"
      via: "Depends injection"
      pattern: "Depends"
---

<objective>
Scaffold the FastAPI backend project with proper directory structure, configuration, and dependency injection.

Purpose: Establish the foundational server structure that all subsequent plans build upon. Without this, no endpoints, auth, or database work can proceed.
Output: A running FastAPI server at server/ with health endpoint, configuration, and DI setup.
</objective>

<execution_context>
@/home/devuser/.claude/get-shit-done/workflows/execute-plan.md
@/home/devuser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@.planning/research/STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FastAPI project scaffold with directory structure</name>
  <files>
    server/__init__.py
    server/app/__init__.py
    server/app/main.py
    server/app/config.py
    server/app/dependencies.py
    server/app/routers/__init__.py
    server/app/models/__init__.py
    server/app/services/__init__.py
    server/app/middleware/__init__.py
    server/app/workers/__init__.py
    server/requirements.txt
    server/pyproject.toml
    server/.env.example
  </files>
  <action>
    Create the server/ directory structure matching the architecture research:

    ```
    server/
    ├── app/
    │   ├── __init__.py
    │   ├── main.py          # FastAPI app, CORS, router includes, lifespan
    │   ├── config.py         # pydantic-settings v2 Settings class
    │   ├── dependencies.py   # Depends() for supabase, redis, stripe
    │   ├── routers/          # API route modules (created in later plans)
    │   │   └── __init__.py
    │   ├── models/           # Pydantic models matching TypeScript interfaces
    │   │   └── __init__.py
    │   ├── services/         # Business logic layer
    │   │   └── __init__.py
    │   ├── middleware/        # Auth, RLS context, logging
    │   │   └── __init__.py
    │   └── workers/          # Celery task definitions
    │       └── __init__.py
    ├── requirements.txt
    ├── pyproject.toml
    └── .env.example
    ```

    **server/app/config.py:**
    - Use `pydantic_settings.BaseSettings` with `model_config = SettingsConfigDict(env_file=".env")`
    - Fields: SUPABASE_URL, SUPABASE_SERVICE_KEY, SUPABASE_ANON_KEY, KEYCLOAK_URL, KEYCLOAK_REALM, KEYCLOAK_CLIENT_ID, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, REDIS_URL (default: redis://localhost:6379), CORS_ORIGINS (list, default: ["http://localhost:3000", "https://app.kijko.nl"]), DEBUG (bool, default: False), API_PREFIX (default: "/api/v1")
    - Export singleton: `settings = Settings()`

    **server/app/dependencies.py:**
    - `get_supabase()` → returns `supabase.create_client(settings.SUPABASE_URL, settings.SUPABASE_SERVICE_KEY)`. Cache with `@lru_cache`.
    - `get_redis()` → returns `redis.asyncio.from_url(settings.REDIS_URL)`. Use lifespan for connection management.
    - `get_stripe()` → sets `stripe.api_key = settings.STRIPE_SECRET_KEY`, returns stripe module.

    **server/app/main.py:**
    - Create FastAPI app with title="Kijko API", version="1.0.0"
    - Add CORS middleware with settings.CORS_ORIGINS, allow_methods=["*"], allow_headers=["*"], allow_credentials=True
    - Add GET /health endpoint returning {"status": "healthy", "version": "1.0.0"}
    - Use lifespan context manager for startup/shutdown (Redis connection pool)
    - Include API_PREFIX in app configuration

    **server/requirements.txt:**
    ```
    fastapi>=0.115.0
    uvicorn[standard]>=0.30.0
    pydantic>=2.0
    pydantic-settings>=2.0
    supabase>=2.0.0
    stripe>=10.0.0
    redis[hiredis]>=5.0.0
    celery[redis]>=5.3.0
    python-socketio>=5.10.0
    python-jose[cryptography]>=3.3.0
    httpx>=0.27.0
    python-multipart>=0.0.9
    ```

    **server/pyproject.toml:**
    - Standard Python project config with [project] metadata
    - Scripts entry: `start = "uvicorn server.app.main:app --host 0.0.0.0 --port 8000 --reload"`

    **server/.env.example:**
    - All config fields with placeholder values and comments
  </action>
  <verify>
    ```bash
    cd server && pip install -r requirements.txt && cd ..
    python -c "from server.app.config import settings; print('Config OK')"
    python -c "from server.app.main import app; print('App OK')"
    ```
  </verify>
  <done>server/ directory structure exists with all __init__.py files, config loads without error, FastAPI app instantiates</done>
</task>

<task type="auto">
  <name>Task 2: Verify server starts and health endpoint responds</name>
  <files>server/app/main.py</files>
  <action>
    Start the FastAPI server and verify the health endpoint:

    1. Start uvicorn in background: `uvicorn server.app.main:app --host 0.0.0.0 --port 8000 &`
    2. Wait 2 seconds for startup
    3. `curl http://localhost:8000/health` — expect {"status": "healthy", "version": "1.0.0"}
    4. `curl http://localhost:8000/docs` — expect Swagger UI HTML
    5. Kill the background uvicorn process

    If health endpoint doesn't return 200, debug and fix before proceeding.

    Also verify CORS headers by checking response headers include Access-Control-Allow-Origin.
  </action>
  <verify>
    ```bash
    cd /home/devuser/Kijko-MVP
    timeout 10 bash -c 'uvicorn server.app.main:app --port 8000 &
    sleep 3
    curl -s http://localhost:8000/health | python3 -c "import sys,json; d=json.load(sys.stdin); assert d[\"status\"]==\"healthy\"; print(\"PASS\")"
    kill %1 2>/dev/null'
    ```
  </verify>
  <done>Health endpoint returns 200 with {"status": "healthy", "version": "1.0.0"}, Swagger docs accessible at /docs</done>
</task>

</tasks>

<verification>
1. `ls server/app/routers/ server/app/models/ server/app/services/ server/app/middleware/ server/app/workers/` — all directories exist
2. `python -c "from server.app.config import Settings; s = Settings(); print(s.API_PREFIX)"` — prints /api/v1
3. `python -c "from server.app.dependencies import get_supabase, get_redis, get_stripe; print('DI OK')"` — imports work
4. Health endpoint returns 200
</verification>

<success_criteria>
- FastAPI server starts without errors
- /health returns {"status": "healthy", "version": "1.0.0"}
- pydantic-settings loads from environment variables
- Dependency injection functions are importable
- All Python dependencies install without conflicts
- Directory structure matches architecture spec
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-auth/01-01-SUMMARY.md`
</output>
