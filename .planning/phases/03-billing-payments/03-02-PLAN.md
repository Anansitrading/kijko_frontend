---
phase: 03-billing-payments
plan: 02
type: execute
wave: 2
wave_type: SEMI_ASYNC
depends_on: ["03-01"]
files_modified:
  - server/app/routers/webhooks.py
  - server/tests/test_billing.py
autonomous: true
difficulty: hard
---

<objective>
Implement Stripe webhook handler with signature verification and subscription lifecycle event processing.

Purpose: Webhooks are the backbone of Stripe — subscription updates, payment failures, and invoice events all come through here. Must verify signatures and handle idempotently.
</objective>

<context>
@server/app/services/stripe_service.py
@server/app/config.py
@server/app/models/billing.py
</context>

<tasks>
<task type="auto">
  <name>Create webhook handler and billing tests</name>
  <files>
    server/app/routers/webhooks.py
    server/tests/test_billing.py
  </files>
  <action>
    Webhook handler (webhooks.py):
    - POST /webhooks/stripe — Stripe webhook endpoint (no auth, signature-verified)
    - Verify webhook signature with STRIPE_WEBHOOK_SECRET
    - Handle events:
      * checkout.session.completed → Activate subscription, link customer
      * customer.subscription.updated → Update subscription status in DB
      * customer.subscription.deleted → Mark subscription cancelled
      * invoice.payment_succeeded → Log successful payment
      * invoice.payment_failed → Send notification, update subscription status
      * payment_method.attached/detached → Update payment method records
    - Idempotent: check event ID to prevent duplicate processing
    - Return 200 for all handled events, 400 for signature failure

    Tests (test_billing.py):
    - Test checkout session creation (mocked Stripe)
    - Test subscription retrieval
    - Test webhook signature verification (valid + invalid)
    - Test webhook event handlers (mocked)
    - Test plan listing
    - Test portal session creation
  </action>
  <done>Webhook handler + billing tests</done>
</task>
</tasks>

<output>
After completion, create `.planning/phases/03-billing-payments/03-02-SUMMARY.md`
</output>
