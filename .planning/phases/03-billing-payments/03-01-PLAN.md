---
phase: 03-billing-payments
plan: 01
type: execute
wave: 1
wave_type: SEMI_ASYNC
depends_on: []
files_modified:
  - server/app/services/stripe_service.py
  - server/app/routers/billing.py
autonomous: true
difficulty: hard
---

<objective>
Implement Stripe integration service and billing router with iDEAL support for Dutch market.

Purpose: Core billing infrastructure — Stripe customer creation, checkout sessions with iDEAL, subscription management, payment methods, invoice listing, billing details with BTW/KVK.
</objective>

<context>
@server/app/models/billing.py
@server/app/config.py
@server/app/middleware/auth.py
</context>

<tasks>
<task type="auto">
  <name>Create Stripe service and billing router</name>
  <files>
    server/app/services/stripe_service.py
    server/app/routers/billing.py
  </files>
  <action>
    Stripe service (stripe_service.py):
    - get_or_create_customer(org_id, email, name) — Stripe customer lifecycle
    - create_checkout_session(customer_id, price_id, success_url, cancel_url, payment_methods=["card","ideal"])
    - get_subscription(subscription_id) → Subscription model
    - update_subscription(subscription_id, price_id) — plan upgrades/downgrades
    - cancel_subscription(subscription_id, at_period_end=True)
    - list_payment_methods(customer_id) → list[PaymentMethod]
    - attach_payment_method(customer_id, payment_method_id)
    - detach_payment_method(payment_method_id)
    - list_invoices(customer_id, limit=20) → list[Invoice]
    - create_portal_session(customer_id, return_url) — Stripe Customer Portal
    - PLAN_PRICES: dict mapping PlanTier × BillingInterval → Stripe price_id
    All amounts in cents (EUR). Use Decimal for all money.

    Billing router (billing.py):
    - GET /billing/plans — List available plans (static, from PLAN_PRICES)
    - POST /billing/checkout — Create Stripe checkout session (iDEAL + card)
    - GET /billing/subscription — Get current subscription
    - PATCH /billing/subscription — Update plan/interval
    - POST /billing/subscription/cancel — Cancel at period end
    - GET /billing/payment-methods — List payment methods
    - POST /billing/payment-methods — Attach payment method
    - DELETE /billing/payment-methods/{pm_id} — Detach payment method
    - GET /billing/invoices — List invoices
    - GET /billing/details — Get billing details (company, BTW, KVK)
    - PATCH /billing/details — Update billing details
    - POST /billing/details/validate-btw — Validate BTW number via VIES
    - POST /billing/portal — Create Stripe Customer Portal session
  </action>
  <done>Stripe service + 13 billing endpoints wired</done>
</task>
</tasks>

<output>
After completion, create `.planning/phases/03-billing-payments/03-01-SUMMARY.md`
</output>
